<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cotizador STL</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three/examples/js/loaders/STLLoader.js"></script>
    <style>
        body {
            text-align: center;
            font-family: Arial, sans-serif;
        }
        #viewer {
            width: 100%;
            max-width: 400px;
            height: 300px;
            margin: auto;
        }
    </style>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const inputFile = document.getElementById('stlFile');
            const priceDisplay = document.getElementById('price');
            const timeDisplay = document.getElementById('time');
            const pricePerCm3 = 0.10; // Precio por cm³ (ajustable)
            const layerHeight = 0.2; // Altura de capa en mm
            const printSpeed = 60; // Velocidad en mm/s

            // Configurar escena de Three.js
            const scene = new THREE.Scene();
            scene.background = new THREE.Color(0xf0f0f0);
            
            const camera = new THREE.PerspectiveCamera(75, 1, 0.1, 1000);
            camera.position.set(0, 0, 100);
            
            const renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(400, 300);
            document.getElementById('viewer').appendChild(renderer.domElement);

            // Agregar luz
            const light = new THREE.DirectionalLight(0xffffff, 1);
            light.position.set(5, 5, 5).normalize();
            scene.add(light);

            const ambientLight = new THREE.AmbientLight(0x404040);
            scene.add(ambientLight);
            
            let mesh = null;
            function animate() {
                requestAnimationFrame(animate);
                if (mesh) mesh.rotation.y += 0.01;
                renderer.render(scene, camera);
            }
            animate();

            inputFile.addEventListener('change', async (event) => {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function (event) {
                    const loader = new THREE.STLLoader();
                    const geometry = loader.parse(event.target.result);
                    
                    geometry.computeBoundingBox();
                    geometry.computeBoundingSphere();
                    
                    let volume = calculateVolume(geometry) / 1000;
                    let price = volume * pricePerCm3;
                    let time = estimatePrintTime(geometry);
                    
                    priceDisplay.textContent = `Costo estimado: $${price.toFixed(2)}`;
                    timeDisplay.textContent = `Tiempo estimado: ${Math.max(time, 0).toFixed(2)} horas`;
                    
                    if (mesh) scene.remove(mesh);
                    
                    const material = new THREE.MeshStandardMaterial({ color: 0x0077ff, wireframe: false });
                    mesh = new THREE.Mesh(geometry, material);
                    
                    const center = geometry.boundingSphere.center;
                    mesh.position.set(-center.x, -center.y, -center.z);
                    
                    scene.add(mesh);
                };
                reader.readAsArrayBuffer(file);
            });

            function calculateVolume(geometry) {
                let position = geometry.attributes.position.array;
                let volume = 0;
                
                for (let i = 0; i < position.length; i += 9) {
                    let v0 = new THREE.Vector3(position[i], position[i + 1], position[i + 2]);
                    let v1 = new THREE.Vector3(position[i + 3], position[i + 4], position[i + 5]);
                    let v2 = new THREE.Vector3(position[i + 6], position[i + 7], position[i + 8]);
                    volume += signedVolumeOfTriangle(v0, v1, v2);
                }
                return Math.abs(volume);
            }

            function signedVolumeOfTriangle(v0, v1, v2) {
                return v0.dot(v1.cross(v2)) / 6.0;
            }

            function estimatePrintTime(geometry) {
                let bbox = geometry.boundingBox;
                if (!bbox) return 0;
                
                let height = Math.abs(bbox.max.z - bbox.min.z);
                let width = Math.abs(bbox.max.x - bbox.min.x);
                let depth = Math.abs(bbox.max.y - bbox.min.y);
                
                let layers = height / layerHeight;
                let timePerLayer = (width * depth) / printSpeed;
                let totalTime = (layers * timePerLayer) / 3600;
                
                return Math.max(totalTime, 0);
            }
        });
    </script>
</head>
<body>
    <h1>Cotizador de impresión 3D</h1>
    <input type="file" id="stlFile" accept=".stl">
    <p id="price">Costo estimado: $0.00</p>
    <p id="time">Tiempo estimado: 0.00 horas</p>
    <div id="viewer"></div>
</body>
</html>
